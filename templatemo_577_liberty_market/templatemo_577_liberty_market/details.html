<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product Details - InvestLoom7x</title>

    <!-- Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/fontawesome.css" rel="stylesheet">
    <link href="assets/css/templatemo-liberty-market.css" rel="stylesheet">
    <link href="assets/css/utils/variables.css" rel="stylesheet">
    <link href="assets/css/navigation.css" rel="stylesheet">
    <link href="assets/css/components/modals.css" rel="stylesheet">

    <!-- Advanced Details CSS -->
    <link href="assets/css/details-advanced.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Scripts -->
    <script src="assets/js/common.js"></script>
</head>

<body>
    <div class="bg-animation"></div>

    <!-- Header -->
    <header class="main-nav">
        <div class="header-content">
            <a href="index.html" class="logo">
                <img src="assets/images/logo.png" alt="INVESTLOOM7X">
            </a>
            <div class="user-account-info" onclick="window.location.href='profile.html'">
                <div class="balance-info">
                    <small class="text-muted">Balance</small>
                    <span id="userBalanceAmount" class="balance-amount">₹0</span>
                </div>
                <img id="userProfilePic" src="assets/images/default-avatar.png" alt="User" class="profile-pic">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="details-container">
        <!-- Back Button -->
        <a href="index.html" class="text-decoration-none text-white mb-4 d-inline-block">
            <i class="fas fa-arrow-left me-2"></i> Back to Market
        </a>

        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Loading plan details...</p>
        </div>

        <div id="productContent" style="display: none;">
            <div class="product-card">
                <div class="product-header">
                    <div class="product-image-wrapper">
                        <img id="productImage" src="" alt="Plan Image">
                    </div>
                    <div class="product-title">
                        <h1 id="productName">Loading...</h1>
                        <span class="product-badge" id="productCategory">Standard Plan</span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Daily Return</div>
                        <div class="stat-value highlight" id="dailyReturn">₹0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Duration</div>
                        <div class="stat-value" id="duration">0 Days</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Return</div>
                        <div class="stat-value highlight" id="totalReturn">₹0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Risk Level</div>
                        <div class="stat-value text-success">Low</div>
                    </div>
                </div>

                <div class="features-list">
                    <div class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Guaranteed daily returns credited to wallet</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>Principal amount secure and insured</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-clock"></i>
                        <span>24/7 withdrawal availability</span>
                    </div>
                </div>

                <div class="action-section">
                    <div class="price-row">
                        <span class="text-muted">Investment Amount</span>
                        <span class="total-price" id="investmentAmount">₹0</span>
                    </div>
                    <button id="purchaseBtn" class="purchase-btn" onclick="initiatePurchase()">
                        Purchase Plan Now
                    </button>
                    <p class="text-center mt-3 text-muted small">
                        <i class="fas fa-lock me-1"></i> Secure Payment Gateway
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i><br><span>Home</span>
        </a>
        <a href="#" class="nav-item active">
            <i class="fas fa-money-bill-wave"></i><br><span>Detail</span>
        </a>
        <a href="trading-activity.html" class="nav-item">
            <i class="fas fa-chart-line"></i><br><span>Activity</span>
        </a>
        <a href="#" class="nav-item" onclick="handleProtectedNavigation('profile.html'); return false;">
            <i class="fas fa-user"></i><br><span>Profile</span>
        </a>
    </nav>

    <!-- Notice Modal -->
    <div class="modal fade" id="noticeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Important
                        Notice</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>By purchasing this plan, you agree to the following terms:</p>
                    <ul class="text-muted small">
                        <li>Investment capital is locked for the duration period.</li>
                        <li>Daily returns are credited every 24 hours.</li>
                        <li>Early withdrawal may attract a penalty fee.</li>
                    </ul>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="agreeCheck">
                        <label class="form-check-label" for="agreeCheck">I understand and agree</label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmPurchaseBtn" disabled
                        onclick="processPurchase()">
                        Confirm Purchase
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/authRedirect.js"></script>
    <script src="assets/js/navigation.js"></script>

    <script>
        let currentProduct = null;
        const UPI_CONFIG = {
            merchantId: 'kum444kartik@oksbi',
            merchantName: 'InvestLoom7x'
        };

        document.addEventListener('DOMContentLoaded', async function () {
            await loadProductDetails();
            updateUserHeader();
        });

        async function loadProductDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                alert('No product specified');
                window.location.href = 'index.html';
                return;
            }

            // Fallback to localStorage for demo
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            currentProduct = products.find(p => (p._id || p.id) == productId);

            if (!currentProduct) {
                // Try sample products if not found
                const samples = [
                    { _id: 'sample-1', name: 'Basic Plan', category: 'Starter', price: 1000, dailyEarning: 50, duration: 100, imageUrl: 'assets/images/discover-01.jpg' },
                    { _id: 'sample-2', name: 'Premium Plan', category: 'Advanced', price: 5000, dailyEarning: 300, duration: 100, imageUrl: 'assets/images/discover-02.jpg' },
                    { _id: 'sample-3', name: 'Elite Plan', category: 'Pro', price: 10000, dailyEarning: 700, duration: 100, imageUrl: 'assets/images/discover-03.jpg' }
                ];
                currentProduct = samples.find(p => p._id == productId);
            }

            if (!currentProduct) {
                alert('Product not found');
                window.location.href = 'index.html';
                return;
            }

            renderProduct(currentProduct);
        }

        function renderProduct(product) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('productContent').style.display = 'block';

            document.getElementById('productName').textContent = product.name;
            document.getElementById('productCategory').textContent = product.category || 'Standard';
            document.getElementById('productImage').src = product.imageUrl || product.image || 'assets/images/discover-01.jpg';

            const daily = product.dailyEarning || 0;
            const duration = product.duration || 100;
            const total = daily * duration;

            document.getElementById('dailyReturn').textContent = `₹${daily}`;
            document.getElementById('duration').textContent = `${duration} Days`;
            document.getElementById('totalReturn').textContent = `₹${total}`;
            document.getElementById('investmentAmount').textContent = `₹${product.price}`;
        }

        function updateUserHeader() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user) {
                document.getElementById('userBalanceAmount').textContent = `₹${user.balance || 0}`;
                if (user.profilePic) document.getElementById('userProfilePic').src = user.profilePic;
            }
        }

        function initiatePurchase() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                sessionStorage.setItem('redirectAfterLogin', window.location.href);
                window.location.href = 'auth/login.html';
                return;
            }

            // Show Notice Modal
            const modal = new bootstrap.Modal(document.getElementById('noticeModal'));
            modal.show();

            // Handle Checkbox
            document.getElementById('agreeCheck').addEventListener('change', function (e) {
                document.getElementById('confirmPurchaseBtn').disabled = !e.target.checked;
            });
        }

        async function processPurchase() {
            const btn = document.getElementById('confirmPurchaseBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

            try {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                const price = currentProduct.price || 0;

                // 1. Launch UPI Intent
                if (isMobileDevice()) {
                    launchUPIIntent(price, 'order_' + Date.now());
                } else {
                    alert(`Please pay ₹${price} to UPI ID: ${UPI_CONFIG.merchantId}\n\n(On mobile, this would open your UPI app automatically)`);
                }

                // 2. Record Pending Purchase
                // Note: We do NOT deduct balance here because the user is paying via UPI directly to Owner
                // We just record the pending investment.

                const investments = JSON.parse(localStorage.getItem('investments') || '[]');
                investments.push({
                    ...currentProduct,
                    purchaseDate: new Date().toISOString(),
                    status: 'pending_approval' // New status
                });
                localStorage.setItem('investments', JSON.stringify(investments));

                // Add Transaction
                const txns = JSON.parse(localStorage.getItem('transactions') || '[]');
                txns.unshift({
                    type: 'purchase',
                    amount: price,
                    date: new Date().toISOString(),
                    status: 'pending',
                    productName: currentProduct.name
                });
                localStorage.setItem('transactions', JSON.stringify(txns));

                // Success Message
                bootstrap.Modal.getInstance(document.getElementById('noticeModal')).hide();
                alert('Payment Initiated! Your plan will be active after owner confirmation.');
                window.location.href = 'profile.html';

            } catch (error) {
                alert(error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function launchUPIIntent(amount, txnId) {
            const upiUrl = `upi://pay?pa=${UPI_CONFIG.merchantId}&pn=${UPI_CONFIG.merchantName}&am=${amount}&tr=${txnId}&cu=INR`;
            window.location.href = upiUrl;
        }
    </script>
</body>

</html>